Отримання IP-адреси користувача в PHP
=====================================

> id: '1d6d761e-c139-4624-8c32-b0f2c131a831'
> slug:
> 	cs: ip-adresa
> 	uk: otrimannya-ip-adresi-koristuvaca-v-php
> 
> perex:
> 	- 'Zjištění IP adresy uživatele v PHP, ukládání IP adresy a ban uživatele. Ošetření VPN a uživatele za Proxy nebo NATem.'
> 	- 'Отримання IP-адреси користувача в PHP, запам''ятовування IP-адреси та бан користувача. Дослідження VPN і користувачів за проксі або NAT.'
> 
> publicationDate: '2020-02-28 10:30:21'
> mainCategoryId: '3666a8a6-f2a3-405d-8263-bd53c4301fb3'
> sourceContentHash: '54a77b5e4cc431b354903e42a27682a6'

У PHP дуже легко визначити IP-адресу на базовому рівні:

```php
echo 'Ви знаєте, що ваша IP-адреса' . $_SERVER['REMOTE_ADDR'] . '?';
```

> Попередження:** Отримання IP-адреси в якості ключа поля `$_SERVER['REMOTE_ADDR']` можливе лише в тому випадку, якщо PHP був викликаний з браузера. В режимі CLI (наприклад, запуск з Терміналу за допомогою cron) IP-адреса недоступна (це логічно, оскільки не виконується запит до мережі).

Надійне визначення IP-адрес
-----------------------------

Після багатьох років розробок я нарешті зупинився на цій реалізації:

```php
function getIp(): string
{
    if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) { // Підтримка Cloudflare
        $ip = $_SERVER['HTTP_CF_CONNECTING_IP'];
    } elseif (isset($_SERVER['REMOTE_ADDR']) === true) {
        $ip = $_SERVER['REMOTE_ADDR'];
        if (preg_match('/^(?:127|10)\.0\.0\.[12]?\d{1,2}$/', $ip)) {
            if (isset($_SERVER['HTTP_X_REAL_IP'])) {
                $ip = $_SERVER['HTTP_X_REAL_IP'];
            } elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
                $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
            }
        }
    } else {
        $ip = '127.0.0.1';
    }
    if (in_array($ip, ['::1', '0.0.0.0', 'localhost'], true)) {
        $ip = '127.0.0.1';
    }
    $filter = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4);
    if ($filter === false) {
        $ip = '127.0.0.1';
    }

    return $ip;
}
```

Тоді набагато краще:

```php
echo 'Ви знаєте, що ваша IP-адреса' . getIp() . '?';
```

Якщо IP може бути визначений безпосередньо, або є тільки IPv6, або знаходиться в режимі CLI (наприклад, cron), він повертає `127.0.0.1` (localhost).

Реалізації, що враховують заголовки `X-Forwarded-For` і `X-Real-IP` вкрай небезпечні безпосередньо в PHP, оскільки дані можуть бути легко модифіковані і зловмисник може підмінити підроблену IP-адресу для, наприклад, перегляду адміністрування або активації режиму налагодження сайту (Nette Tracy). З іншого боку, нам доводиться приймати деякі проксі-запити (наприклад, при проксі трафіку через Cloudflare, або при запуску Apache і Ngnix на одній машині, коли вони викликаються локально відразу один за одним).

У випадку прямого доступу користувача до сервера є тільки одне правильне рішення - забезпечити в Apache (через розширення `RemoteIP`) і в Nginx через розширення `remote_ip`, щоб `X-Forwarded-For` встановлювався з фактичної IP-адреси відвідувача, і щоб IP-адресу не можна було встановити за допомогою HTTP-заголовка.

Поле `$_SERVER['REMOTE_ADDR']` автоматично отримує правильну IP-адресу (тобто IP-адресу, з якої прийшов запит безпосередньо до PHP) і нам не потрібно з ним розбиратися.

Доступ користувачів через проксі
----------------------------

Часто буває так, що користувач заходить через проксі. Після чого актуальна IP-адреса зберігається у змінній `$_SERVER['HTTP_X_FORWARDED_FOR']`.

Такий випадок може мати місце, наприклад, коли маршрутизація на сервері вирішується методом `Ngnix -> Apache -> PHP`, де `Ngnix` служить зворотним проксі перед `Apache`. В цьому випадку PHP бачить тільки IP-адресу в межах внутрішньої мережі (зазвичай виду `127.0.0.*`).

Наприклад, таким чином може поводитися сервіс **Cloudflare**, і слід звертати увагу на те, чи працюємо ми з IP-адресою фактичного користувача, чи проксі-сервера. Для мене найкращим способом є використання функції `getIp()`, згаданої на початку цієї статті. Ми можемо забезпечити виявлення Cloudflare шляхом перевірки наявності ключа `$_SERVER['HTTP_CF_CONNECTING_IP']`, який автоматично передається в кожному проксі-запиті.

Збереження IP-адреси
------------------

Це залежить від того, яку IP-адресу ви маєте в наявності.

- IPv4 IP-адреса може зберігатися в 4 байтах, для цього використовується функція `ip2long`,
- Однак, для IPv6 IP-адреси доводиться використовувати 16 байт, а функція перетворення відсутня.

Якщо ваш сервер баз даних безпосередньо не підтримує тип даних для IP-адреси, рекомендую зберігати IP-адресу у вигляді `varchar(39)`, де обидві версії помістяться у вигляді рядка і будуть читабельними для людини.

> При збереженні IP-адреси слід враховувати, чи є сенс зберігати також доменне ім'я, визначене функцією `gethostbyaddr`. При внесенні до списку та пошуку дізнатися прізвища неможливо, оскільки це займає дуже багато часу і вони можуть змінюватися з плином часу.

Блокування IP-адреси відвідувача
-----------------------------

Ідеальним рішенням є створення списку заблокованих IP-адрес і порівняння цього списку з поточною IP-адресою при кожному запиті. Якщо адреси збігаються, запит буде негайно зупинено.

```php
$blackList = [
    'first-ip',
    'druha-ip',
];

if (\in_array(getIp(), $blackList, true) === true) {
    echo 'На жаль ваша ip-адреса заблокована :-(';
    die; // Запит на вихід
}
```

У прикладі передбачається реалізація функції `getIp()` як у прикладі вище.

Більш потужним рішенням є перевірка на входження індексу в масив:

```php
$blackList = [
    'first-ip' => true,
    'druha-ip' => true,
];

if (isset($blackList[getIp()]) === true) {
    echo 'На жаль ваша ip-адреса заблокована :-(';
    die; // Запит на вихід
}
```

IP-адреса та ім'я сервера
---------------------------------

IP-адреса сервера зазвичай зберігається в полі `$_SERVER['SERVER_ADDR']`, а його ім'я можна отримати за допомогою конструкції `gethostbyaddr($_SERVER['SERVER_ADDR'])`.

Однак, якщо використовується концепція `Ngnix -> Apache -> PHP` і `Ngnix` виступає в ролі зворотного проксі, то реальна IP-адреса сервера не відображається.

При цьому ім'я сервера можна знайти в полі `$_SERVER['SERVER_NAME']`, або за допомогою функції `php_uname('n')`. [Офіційна документація функції uname] (https://www.php.net/manual/en/function.php-uname.php).

Потім ми можемо використовувати цей трюк, щоб дізнатися публічну IP-адресу сервера: `gethostbyname(php_uname('n'))`.
