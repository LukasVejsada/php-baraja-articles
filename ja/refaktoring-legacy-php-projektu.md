レガシーPHPプロジェクトのリファクタリング - 技術的負債を取り戻す方法
=====================================

> id: '8f37305a-e9dd-4b1e-9f53-04f0fca648f7'
> slug:
> 	cs: refaktoring-legacy-php-projektu
> 	ja: regashiphppurojekutonorifakutaringu-ji-shu-de-fu-zhaiwo-quri-tisu-fang-fa
> 
> publicationDate: '2021-05-11 20:45:00'
> mainCategoryId: '3666a8a6-f2a3-405d-8263-bd53c4301fb3'
> sourceContentHash: b13673b23a86bc82a88636e4a9464b4b

知識や経験の豊富なプロジェクトオーナーとコンサルティングをしていると、デジタルプロジェクトの長期的な持続可能性についての問題によく出くわします。多くの大規模プロジェクトは、開発期間が3年を超えると、内部的に陳腐化し、持続不可能になります。ここで、さまざまなレベルの知識、経験、そして最も重要な勤勉さを持つ開発者のチームを想像してみてください。

デジタルプロジェクトを技術的にTOPレベルに維持するために、必要なこと。

- 有能な開発者とプロジェクトマネージャー**は、素晴らしいコミュニケーションをとり、誰もが自分のしていることと、それが他の人にどのような影響を与えるかを理解しています。
- **チーム全体が知っている機能的なツールやワークフロー**は、それに応じて他の人に仕事を適応させる。
- 忘れがちな日々のルーティンを提供する**自動化されたタスク**は、非常に重要です。

大規模なプロジェクトを開発する場合、単純に簡単にはいきません。正しいことをするのも大事ですが、もっと大事なことがあるんです。

リファクタリングとは何か、なぜ必要なのか
---------------------------------------

リファクタリングの概念は、周辺環境に影響を与えることなく、プログラムのコードの外観や内部ロジックを修正する一連の活動を包含しています。リファクタリングのプロセスは、クリスマスの大掃除と考えることができます。同じままですが、より整理され、不要なものは捨てられます。また、リファクタリングでは、一回きりのイベントではなく、一定のサイクルで繰り返す長期的なプロセスであることを念頭に置くことが重要です。これをやらないと、いろいろな変なミスや金銭的な損失、オンボーディングの問題、泣き寝入りすることになる。

プロジェクトを安定させ、最新の状態に保つことができれば、大きな利益を得ることができます。

- プロジェクトは、**より安全**なものになります。お客様が使用するライブラリには、バグやセキュリティ上の脆弱性を修正するパッチが定期的にリリースされています。セキュリティは健全なプロジェクトの基本的な生命機能の1つです。
- コードや内部アーキテクチャがよりシンプルになり、よりよく考え抜かれるようになります。バグを発見しやすくなり、多くのバグは未然に防ぐこともできます。
- コードが単純化されていれば、ジュニア開発者を連れてきて、<a href="https://www.youtube.com/watch?v=1wZtdIb-Ppk">全体の予算を大幅に削減</a>することも可能です。
- いくつかのことを複雑にしすぎて、複雑にしすぎていることに気づくかもしれません。プロジェクトは全体的にシンプルになります。

大規模なデジタルプロジェクトで軌道に乗るためには、走らなければなりません。でも、成長したいんですよね。

安全なリファクタリングの方法
-------------------------

リファクタリングのたびに大きな賭けに出て、報われないかもしれない。

私は、リファクタリングに着手するずっと前に、必ず安定した環境を確保するようにしています。

安定性を確保するためには、特に**機能的なエラーログ**が必要です。単純なプロジェクトであれば、エラーを HTML ファイルに記録する <a href="https://tracy.nette.org">Tracy</a> があればよいでしょう。より高度なプロジェクトでは、<a href="https://sentry.io/welcome/">Sentry</a> や <a href="https://rollbar.com">Rollbar</a> といったツールが登場します。私自身は、すべてのプロジェクトでTracyを使用し、プロジェクトの種類に応じて他のツールを使用しています。

リファクタリングの約1ヶ月前からバグの追跡を開始し、後で重点的に取り組む既知のバグのスプレッドシートを作成します。リファクタリングによって発生したバグと、過去にプロジェクトが持っていたバグを知ることは、常に重要なことです。そうすることで、クライアントに対して仕事の成果をよりよく説明することができるのです。

ログを見ることで、比較的安定した環境で作業していることがわかれば、あとは本題に入るだけです。その他に、リスクの大きさによって方法を分類しています。

コーディングスタイルとコーディングスタンダードの修正
-----------------------------------

ほとんどのプロジェクトでは、コードの書式が統一されていません。これは大きな間違いです。よくできたプロジェクトは、すべてのことが同じように書かれている、一人の人間のプロジェクトのように見えるのです。

基本的なフォーマットのエラーは、プロジェクト全体に定期的にかけている<a href="https://doc.nette.org/en/3.1/code-checker">Netteコードチェッカー</a>というツールでしっかり修正しています。

一方、コーディングスタイルは、コードの書式や個々の言語表現のインデントなどを扱う。<a href="https://www.php-fig.org/psr/psr-12/">PSR-12</a> 規格は、PHPの世界で多く使われており、他の非常に多くの規格がこれに基づいています。使うことをおすすめします。

プロジェクトによっては、<a href="/spaces-and-tabs">タブとスペースを不格好に組み合わせているものがあります</a>。空白の規約違反（およびその他のエラー）を効果的に防ぐには、プロジェクトルートに `.editorconfig` ファイルを作成して、新しく書かれたコードをどのようにフォーマットするかをエディタに指示します。

私自身はこの構成で使っています。

```txt
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{php,phpt}]
indent_style = tab
indent_size = 4
```

また、すべての<a href="/apostrophes-and-carriage-notes">carriage-notesをアポストロフィに修正します</a>。自動的に行うことができます。

また、コードの書式を自動的にチェックすることもできます。これについては、<a href="https://github.com/baraja-core/sandbox/blob/0db1f41068b6cedf79500c6a8b0ac26eae94a8eb/.github/workflows/coding-style.yml">GitHub</a>に十分に機能するデモを用意しました。コードの自動修正も必要な場合は、同じツールで行うことができます。また、PhpStormは、プロジェクト全体にわたって一括してでも、コードを直接自動修正することに非常に優れています。

大規模プロジェクトにおけるCoding Styleの修正方法
----------------------------------------------

大規模なプロジェクトでは、自動コード整形を1モジュールずつ行うことをお勧めします。これは、Gitに膨大な数のコンフリクトを発生させる可能性があるからです。したがって、最良の戦略は、ひとつの大きなコミットでできるだけ多くの行を修正し、そのコミットを直接マスターにプッシュし、それから他のブランチに変更を分散させることです。

コンフリクトが大きすぎる場合、まずmasterでコードをフォーマットし、その後、変更の多い大きなブランチごとに再度フォーマットすることは理にかなっています。非常に多くの変更されたラインが互いに相殺される（早送りをする）ので、非常に少ないコンフリクトを解決することができ、時にはコンフリクトが発生しないこともあります。

何もしなければ、コードが悪いままです。なぜなら、マージするたびに、実際には何も変更されていない何十行もの行を修正する必要が生じ、コードレビューと変更の差し戻しの両方を不必要に複雑化させるからです。

PhpStan - 静的コード解析と型エラー修正
------------------------------------------------------

大規模なロジックの修正に着手する前に、**プロジェクトのライフサイクルの基本的な機能**を見直し、修正することが非常に重要です。この中には、どんなプロジェクトでも期待するような当たり前のことが含まれていますが、それでも満たされないことがあります。

例えば、こんな感じです。

- すべてのクラス、メソッド、関数が存在すること
- クラス継承を壊してはならない
- クラスは、使用されるインタフェースまたは祖先のインタフェースを実装しなければならない。同時に、`final` クラスを継承してはいけません。
- eval()`、`shell_exec()`、`var_dump()` などの安全でない関数を呼び出してはいけません。また、どうせ呼ぶなら、コメントで明示する必要がある
- 常に例外をキャッチし、アプリケーション全体をクラッシュさせないようにしなければならない

この問題の解決策は、<a href="https://phpstan.org">PhpStan</a>をプロジェクトにインストールし、**少なくともレベル1**に修正することです。そう、大変なんです、そう、大変なんです。しかし、もしそれをしなければ、すべてのリファクタリングがロシアンルーレットとなり、開発者は被害ができるだけ少なくなることを願うだけです。

PhpStanの基本レベルでは、例えばデータ型などの形式的なものがどこにでも存在する必要はないのですが、これは将来的に対応する予定です。一方、ある関数やメソッドがあるデータ型を返すが、typehintで他のデータ型をアサートするということはないかもしれない。

レクター - 安全な繰り返し修理
-----------------------------------

よく知られたプログラミングの格言に、システムに新しいエラー（例外を投げるなど）を追加する前に、まずそのエラーを警告として追加し、長い間現れなかった場合にのみ致命的なエラーにするべきだというものがある。

データ型も同じです。未知のコードをリファクタリングするときは、<a href="https://getrector.org">Rector</a>のような自動ツールに、まずコードにコメント注釈を追加させます。これは何も壊さないのですが、何がどこにあるのかを後で明確にするのに役立ちます。これらのコメントはPhpStanによって聞かれ、何も壊していないこと、安全な改造であることを安全に確認するために使用することができます。

私は大体1回のコミットでプロパティや引数にコメントを追加し、その後1ヶ月くらい待って、長期的に全てがうまくいったところで、長期的に問題がなかったところを固定データ型に書き換えるという手段をとっています。

<a href="https://tomasvotruba.com/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/">How we Completed Thousands of Missing @var Annotations in a Day</a> の記事をご覧ください。

<a href="https://github.com/rectorphp/rector">Rectorについては、GitHub</a>を参照してください。

依存関係を更新する
----------------------

パッケージの依存関係やPHPのバージョンの更新に入る前に、<a href="/github-actions-best-ci-for-2021">自動テストの使い方</a>を研究し学ぶことが重要です。

テストがうまくいっていれば、<a href="/composer">Composer</a>ツールで更新を実行できます。もし可能なら、プロジェクトの `composer.json` を自動的に更新し、互換性の変更をチェックできる <a href="https://dependabot.com">Dependabot</a> ロボットの助けを借りてください。

もし、大きな変更がある場合は、常にゆっくりと変更を加え、バージョンごとにインクリメントしてください。一度に多くのパッケージをアップデートしないでください。アップデートのたびに、PhpStanでプロジェクト全体をスキャンし、バグを修正する。数時間かかる長丁場だが、その分、苦労も多い。

次に進むべき道
-------

次のステップは、プロジェクトの種類と状況によって個別になります。一般的に、ウェブ開発を副業としているメディアエージェンシーに勤める若手から安く買ったコードよりも、シニア開発者によって書かれた優れたデザインのコードの方が、メンテナンス性は桁違いに高いのです。

祈っています。大変だろうけど、きっと乗り越えられるよ。
